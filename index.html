<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UltraNítido - Upscale de Imagens com ESRGAN</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 20px 0 40px 0;
            background: linear-gradient(135deg, #23c46c 0%, #1a9552 100%);
            color: white;
            margin-bottom: 30px;
        }
        
        .logo {
            max-width: 350px; /* Ajustado para 350px conforme solicitado */
            height: auto;
            margin: 0 auto 20px auto;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .logo:hover {
            transform: scale(1.05);
        }
        
        .logo svg {
            width: 100%;
            height: auto;
        }
        
        .logo path, .logo ellipse, .logo rect, .logo circle {
            fill: white !important;
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .upload-area {
            background: white;
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: #23c46c;
            background: #f0fdf4;
        }
        
        .upload-area.dragover {
            border-color: #23c46c;
            background: #e6f9ef;
        }
        
        .options {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .option-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        select, input[type="number"], input[type="range"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        input[type="range"] {
            padding: 0;
            height: 40px;
        }
        
        .slider-value {
            text-align: right;
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .btn {
            background: #23c46c;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            animation: glow 2s infinite;
        }
        
        @keyframes glow {
            0% { box-shadow: 0 0 5px #23c46c; }
            50% { box-shadow: 0 0 20px #23c46c; }
            100% { box-shadow: 0 0 5px #23c46c; }
        }
        
        .btn:hover {
            background: #1a9552;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            animation: none;
        }
        
        .preview-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }
        
        .preview-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .preview-box h3 {
            margin-bottom: 15px;
            color: #444;
        }
        
        .preview-box img {
            max-width: 100%;
            border-radius: 5px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #23c46c;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .info-box {
            background: #e0f2e9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #23c46c;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-box a {
            color: #23c46c;
            text-decoration: none;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .info-box a:hover {
            text-decoration: underline;
        }
        
        .instagram-icon {
            width: 20px;
            height: 20px;
            fill: #23c46c;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        #downloadBtn {
            display: none;
            margin-top: 20px;
        }
        
        .model-loading {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
            display: none;
        }
        
        .progress-bar {
            height: 10px;
            width: 100%;
            background: #eee;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .progress {
            height: 100%;
            background: #23c46c;
            border-radius: 5px;
            width: 0%;
            transition: width 0.3s;
        }
        
        @media (max-width: 768px) {
            .preview-area {
                grid-template-columns: 1fr;
            }
            
            header {
                padding: 20px 0;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .upload-area {
                padding: 20px;
            }
            
            .logo {
                max-width: 150px;
            }
        }
    </style>
</head>
<body>
    <header>
        <a href="https://www.instagram.com/marcossvinx/" target="_blank" class="logo">
            <svg id="Camada_1" data-name="Camada 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 186.42 87.9">
                <ellipse class="cls-1" cx="67.48" cy="23.59" rx="9.23" ry="10.97"/>
                <g>
                    <path d="M6.09,38.21V0h16.86c7.48,0,12.26,5.47,12.26,12.37s-4.78,11.97-12.26,11.97h-8.86v13.87h-8ZM21.68,17.84c4.6,0,6.5-2.36,6.5-5.7,0-3.16-1.9-5.52-6.5-5.52h-7.6v11.22h7.6Z"/>
                    <path d="M36.99,38.21V9.9h7.02v3.4c2.47-3.8,5.35-4.14,8.4-4.14h.98v7.65c-.69-.12-1.38-.17-2.07-.17-4.6,0-6.85,2.3-6.85,6.85v14.73h-7.48Z"/>
                    <path d="M53.1,24.05c0-8.98,5.58-14.9,14.56-14.9s14.39,5.87,14.39,14.9-5.58,14.9-14.39,14.9-14.56-6.1-14.56-14.9ZM74.51,24.05c0-5.75-2.3-8.57-6.85-8.57s-6.85,2.82-6.85,8.57,2.3,8.63,6.85,8.63,6.85-2.88,6.85-8.63Z"/>
                    <path d="M117.95,38.21v-17.15c0-3.4-1.78-5.81-4.43-5.81s-4.78,2.59-4.78,6.04v16.92h-7.48v-17.03c0-4.55-1.21-5.7-4.49-5.7-2.99,0-4.55,1.84-4.55,5.52v17.2h-7.48V9.9h7.02v4.14c1.9-3.74,4.55-4.89,8.29-4.89s5.7,1.21,7.88,4.49c1.55-3.11,4.09-4.49,7.65-4.49,5.7,0,9.67,4.14,9.67,9.44v19.62h-7.31Z"/>
                    <path d="M128.14,51.61V9.9h7.19l.06,3.45c1.78-2.88,4.43-4.2,7.88-4.2,7.13,0,12.26,5.64,12.26,15.19,0,8.57-4.32,14.62-11.62,14.62-3.51,0-6.27-1.44-8.4-4.43v17.09h-7.37ZM147.93,23.82c0-5.06-2.65-8.57-6.39-8.57s-6.33,3.34-6.33,8.11c0,6.16,2.13,9.21,6.27,9.21,4.37,0,6.44-2.93,6.44-8.75Z"/>
                    <path d="M174.29,19.56h6.96v8.06c0,5.98-3.45,11.34-11.45,11.34s-11.57-5.29-11.57-11.39V2.24h7.37v7.65h15.65v5.29h-15.65v11.62c0,3.57,1.27,5.64,4.32,5.64s4.37-2.01,4.37-5.52v-7.37Z"/>
                </g>
                <g>
                    <path d="M34.11,72.88c-3.23,9.03-10.35,15.02-19.33,15.02S0,82.21,0,71.56c0-15.38,9.27-26.09,22.38-26.09,9.15,0,14.12,5.68,14.12,13.1,0,.42-.06.84-.06,1.26h-6.4c0-.42.06-.78.06-1.14,0-5.62-3.35-7.66-8.62-7.66-9.63,0-14.9,8.62-14.9,19.81,0,8.26,3.17,11.49,8.98,11.49,6.28,0,10.23-3.59,12.15-9.45h6.4Z"/>
                    <path d="M42.9,73.3c-.06.6-.06,1.26-.06,1.85,0,5.5,2.39,7.42,6.7,7.42,3.17,0,6.16-1.74,7.48-4.73h6.22c-2.81,6.04-8.14,9.45-14.3,9.45-8.02,0-12.03-4.13-12.03-12.09,0-11.97,7.3-18.91,17.05-18.91,7.24,0,10.95,4.13,10.95,11.73,0,1.62-.18,3.35-.48,5.27h-21.54ZM58.94,69.47c.12-.96.18-1.79.18-2.51,0-4.67-2.57-5.86-6.16-5.86-4.55,0-8.14,2.87-9.51,8.38h15.5Z"/>
                    <path d="M66.6,86.52l5.21-29.44h5.62l-.96,5.27c3.23-5.03,7.18-6.04,10.77-6.04h1.32l-1.08,6.16c-.66-.12-1.38-.18-2.15-.18-5.8,0-9.09,3.71-10.05,9.09l-2.69,15.14h-5.98Z"/>
                    <path d="M108.42,67.13h5.56l-1.5,8.38c-1.14,6.22-5.5,11.79-13.64,11.79-7.12,0-9.93-3.95-9.93-9.03,0-.9.12-1.85.3-2.81l4.61-26.33h5.92l-1.38,7.96h17.41l-.78,4.31h-17.41l-2.39,13.52c-.18,1.02-.24,1.85-.24,2.63,0,3.23,1.5,4.55,4.91,4.55,4.01,0,6.4-2.87,7.18-7.12l1.38-7.84Z"/>
                </g>
                <g>
                    <rect class="cls-1" x="135.91" y="35.05" width="29.3" height="71.72" rx="13.12" ry="13.12" transform="translate(79.66 221.47) rotate(-90)"/>
                    <g>
                        <path d="M161.45,69.14l3.66-.96c2.02-.53,3.59-2.1,4.12-4.12l.96-3.66.96,3.66c.53,2.02,2.1,3.59,4.12,4.12l3.66.96-3.66,.96c-2.02,.53-3.59,2.1-4.12,4.12l-.96,3.66-.96-3.66c-.53-2.02-2.1-3.59-4.12-4.12l-3.66-.96Z"/>
                        <path d="M159.42,76.92l1.74-.46c.96-.25,1.71-1,1.96-1.96l.46-1.74.46,1.74c.25.96,1,1.71,1.96,1.96l1.74.46-1.74,.46c-.96,.25-1.71,1-1.96,1.96l-.46,1.74-.46-1.74c-.25-.96-1-1.71-1.96-1.96l-1.74-.46Z"/>
                        <path d="M154.63,72.08l1.21-.32c.67-.17,1.19-.7,1.36-1.36l.32-1.21.32,1.21c.17.67,.7,1.19,1.36,1.36l1.21,.32-1.21,.32c-.67,.17-1.19,.7-1.36,1.36l-.32,1.21-.32-1.21c-.17-.67-.7-1.19-1.36-1.36l-1.21-.32Z"/>
                    </g>
                    <circle cx="129.54" cy="70.91" r="10.51"/>
                </g>
            </svg>
        </a>
        <h1>UltraNítido</h1>
        <p class="subtitle">Aumenta qualidade de suas imagens para 4K com ESRGAN - Grátis!</p>
    </header>
    
    <div class="container">
        <div class="info-box">
            <p>Este é um projeto feito por:</p>
            <a href="https://www.instagram.com/marcossvinx/" target="_blank">
                <svg class="instagram-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                </svg>
                @marcossvinx
            </a>
            <span>para comunidade Prompt Certo</span>
        </div>
        
        <div class="model-loading" id="modelLoading">
            <h3>Carregando modelo ESRGAN...</h3>
            <p>Isso pode levar alguns segundos na primeira vez</p>
            <div class="progress-bar">
                <div class="progress" id="modelProgress"></div>
            </div>
        </div>
        
        <div class="upload-area" id="dropZone">
            <input type="file" id="fileInput" accept="image/*" style="display: none">
            <h3>Arraste uma imagem aqui</h3>
            <p>ou clique para selecionar</p>
            <p style="font-size: 0.9em; color: #666; margin-top: 10px">Formatos: JPG, PNG, WebP</p>
        </div>
        
        <div class="options">
            <div class="option-group">
                <label>Modelo ESRGAN:</label>
                <select id="esrganModel">
                    <option value="2x">2x (Rápido)</option>
                    <option value="4x" selected>4x (Qualidade 4K)</option>
                </select>
            </div>
            
            <div class="option-group">
                <label>Aprimoramento HDR:</label>
                <select id="hdrEnhance">
                    <option value="low">Baixo</option>
                    <option value="medium" selected>Médio</option>
                    <option value="high">Alto</option>
                </select>
            </div>
            
            <div class="option-group">
                <label>Nitidez: <span id="sharpnessValue">70%</span></label>
                <input type="range" id="sharpness" min="0" max="100" value="70">
            </div>
            
            <div class="option-group">
                <label>Brilho: <span id="brightnessValue">10</span></label>
                <input type="range" id="brightness" min="-50" max="50" value="10">
            </div>
            
            <div class="option-group">
                <label>Contraste: <span id="contrastValue">15</span></label>
                <input type="range" id="contrast" min="-50" max="50" value="15">
            </div>
            
            <div class="option-group">
                <label>Saturação: <span id="saturationValue">15</span></label>
                <input type="range" id="saturation" min="-50" max="50" value="15">
            </div>
            
            <button class="btn" id="processBtn" disabled>Processar Imagem</button>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Processando imagem em 4K com ESRGAN...</p>
        </div>
        
        <div class="preview-area" id="previewArea" style="display: none;">
            <div class="preview-box">
                <h3>Original</h3>
                <img id="originalPreview">
                <p id="originalInfo"></p>
            </div>
            <div class="preview-box">
                <h3>Processada (Qualidade 4K ESRGAN)</h3>
                <img id="processedPreview">
                <p id="processedInfo"></p>
            </div>
        </div>
        
        <button class="btn" id="downloadBtn">⬇️ Baixar Imagem em Qualidade 4K</button>
    </div>

    <!-- Carregar as bibliotecas necessárias -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/upscaler"></script>
    <script src="https://cdn.jsdelivr.net/npm/@upscalerjs/esrgan-legacy/dist/umd/gans.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@upscalerjs/esrgan-slim/dist/umd/2x.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@upscalerjs/esrgan-slim/dist/umd/4x.min.js"></script>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const processBtn = document.getElementById('processBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const loading = document.getElementById('loading');
        const previewArea = document.getElementById('previewArea');
        const modelLoadingDiv = document.getElementById('modelLoading');
        const modelProgressBar = document.getElementById('modelProgress');
        
        // Sliders
        const sharpnessSlider = document.getElementById('sharpness');
        const brightnessSlider = document.getElementById('brightness');
        const contrastSlider = document.getElementById('contrast');
        const saturationSlider = document.getElementById('saturation');
        
        // Value displays
        const sharpnessValue = document.getElementById('sharpnessValue');
        const brightnessValue = document.getElementById('brightnessValue');
        const contrastValue = document.getElementById('contrastValue');
        const saturationValue = document.getElementById('saturationValue');
        
        let originalImage = null;
        let processedImageData = null;
        let upscaler = null;
        
        // Inicializar o upscaler com o modelo ESRGAN
        async function initUpscaler() {
            modelLoadingDiv.style.display = 'block';
            
            try {
                // Carregando os progressos do modelo
                modelProgressBar.style.width = '30%';
                
                // Criar o upscaler com o modelo ESRGAN
                upscaler = new Upscaler({
                    model: ESRGANSlim4x, // Iniciar com o modelo 4x
                    progress: (progress) => {
                        modelProgressBar.style.width = `${30 + progress * 70}%`;
                    }
                });
                
                await upscaler.load();
                
                modelProgressBar.style.width = '100%';
                setTimeout(() => {
                    modelLoadingDiv.style.display = 'none';
                }, 1000);
                
                console.log('Modelo ESRGAN carregado com sucesso');
            } catch (error) {
                console.error('Erro ao carregar o modelo ESRGAN:', error);
                alert('Erro ao carregar o modelo ESRGAN. Por favor, recarregue a página e tente novamente.');
            }
        }
        
        // Inicializar o upscaler quando a página carregar
        window.addEventListener('load', initUpscaler);
        
        // Update slider values
        sharpnessSlider.addEventListener('input', () => {
            sharpnessValue.textContent = `${sharpnessSlider.value}%`;
        });
        
        brightnessSlider.addEventListener('input', () => {
            brightnessValue.textContent = brightnessSlider.value;
        });
        
        contrastSlider.addEventListener('input', () => {
            contrastValue.textContent = contrastSlider.value;
        });
        
        saturationSlider.addEventListener('input', () => {
            saturationValue.textContent = saturationSlider.value;
        });
        
        // Drag and drop
        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });
        
        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('Por favor, selecione uma imagem.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                originalImage = new Image();
                originalImage.onload = () => {
                    document.getElementById('originalPreview').src = originalImage.src;
                    document.getElementById('originalInfo').textContent = 
                        `${originalImage.width} x ${originalImage.height} pixels`;
                    previewArea.style.display = 'grid';
                    processBtn.disabled = false;
                };
                originalImage.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // Função para mudar o modelo ESRGAN quando o usuário mudar a seleção
        document.getElementById('esrganModel').addEventListener('change', async function() {
            const modelType = this.value;
            modelLoadingDiv.style.display = 'block';
            modelProgressBar.style.width = '30%';
            
            try {
                // Trocar o modelo baseado na seleção
                if (modelType === '2x') {
                    upscaler = new Upscaler({
                        model: ESRGANSlim2x,
                        progress: (progress) => {
                            modelProgressBar.style.width = `${30 + progress * 70}%`;
                        }
                    });
                } else { // 4x
                    upscaler = new Upscaler({
                        model: ESRGANSlim4x,
                        progress: (progress) => {
                            modelProgressBar.style.width = `${30 + progress * 70}%`;
                        }
                    });
                }
                
                await upscaler.load();
                
                modelProgressBar.style.width = '100%';
                setTimeout(() => {
                    modelLoadingDiv.style.display = 'none';
                }, 1000);
                
                console.log(`Modelo ESRGAN ${modelType} carregado com sucesso`);
            } catch (error) {
                console.error('Erro ao trocar o modelo ESRGAN:', error);
                alert('Erro ao trocar o modelo ESRGAN. Por favor, tente novamente.');
                modelLoadingDiv.style.display = 'none';
            }
        });
        
        // Função para aplicar efeitos HDR
        function applyHDREffect(imageData, level) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const width = imageData.width;
            const height = imageData.height;
            
            canvas.width = width;
            canvas.height = height;
            
            // Colocar a imagem no canvas
            ctx.putImageData(imageData, 0, 0);
            
            // Obter os pixels
            const data = ctx.getImageData(0, 0, width, height).data;
            const newImageData = ctx.createImageData(width, height);
            const newData = newImageData.data;
            
            // Fatores de intensidade baseados no nível escolhido
            let intensity;
            switch (level) {
                case 'low': intensity = 0.3; break;
                case 'high': intensity = 0.9; break;
                default: intensity = 0.6; // medium
            }
            
            // Aplicar o efeito HDR
            for (let i = 0; i < data.length; i += 4) {
                // Converter para HSL para manipular saturação e luminância
                const [r, g, b] = [data[i], data[i + 1], data[i + 2]];
                const [h, s, l] = rgbToHsl(r, g, b);
                
                // Aumentar o contraste em áreas claras e escuras
                const newL = l < 0.5 
                    ? l * (1 - intensity * 0.5)  // Escurecer sombras
                    : l + (1 - l) * intensity;    // Clarear realces
                    
                // Aumentar saturação em cores vibrantes
                const newS = s + (1 - s) * intensity * 0.7;
                
                // Converter de volta para RGB
                const [newR, newG, newB] = hslToRgb(h, newS, newL);
                
                // Aplicar os novos valores
                newData[i] = newR;
                newData[i + 1] = newG;
                newData[i + 2] = newB;
                newData[i + 3] = data[i + 3]; // Manter o alpha
            }
            
            ctx.putImageData(newImageData, 0, 0);
            return newImageData;
        }
        
        // Conversão de RGB para HSL
        function rgbToHsl(r, g, b) {
            r /= 255;
            g /= 255;
            b /= 255;
            
            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            
            if (max === min) {
                h = s = 0; // acromático
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                
                h /= 6;
            }
            
            return [h, s, l];
        }
        
        // Conversão de HSL para RGB
        function hslToRgb(h, s, l) {
            let r, g, b;
            
            if (s === 0) {
                r = g = b = l; // acromático
            } else {
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1/6) return p + (q - p) * 6 * t;
                    if (t < 1/2) return q;
                    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                };
                
                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                
                r = hue2rgb(p, q, h + 1/3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1/3);
            }
            
            return [r * 255, g * 255, b * 255].map(Math.round);
        }
        
        // Função para aplicar nitidez usando Unsharp Mask
        function applySharpness(imageData, amount) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = imageData.width;
            canvas.height = imageData.height;
            
            ctx.putImageData(imageData, 0, 0);
            
            // Criar uma cópia desfocada da imagem
            const blurredCanvas = document.createElement('canvas');
            const blurredCtx = blurredCanvas.getContext('2d');
            blurredCanvas.width = imageData.width;
            blurredCanvas.height = imageData.height;
            
            blurredCtx.putImageData(imageData, 0, 0);
            blurredCtx.filter = `blur(2px)`;
            blurredCtx.drawImage(canvas, 0, 0);
            
            // Aplicar o efeito unsharp mask
            ctx.globalCompositeOperation = 'lighter';
            ctx.globalAlpha = amount / 100;
            ctx.drawImage(canvas, 0, 0);
            ctx.globalAlpha = -amount / 100;
            ctx.drawImage(blurredCanvas, 0, 0);
            
            return ctx.getImageData(0, 0, imageData.width, imageData.height);
        }
        
        // Função para ajustar brilho e contraste
        function adjustBrightnessContrast(imageData, brightness, contrast, saturation) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = imageData.width;
            canvas.height = imageData.height;
            
            ctx.putImageData(imageData, 0, 0);
            
            // Aplicar ajustes
            ctx.filter = `
                brightness(${100 + brightness}%) 
                contrast(${100 + contrast}%) 
                saturate(${100 + saturation}%)
            `;
            
            ctx.drawImage(canvas, 0, 0);
            
            return ctx.getImageData(0, 0, imageData.width, imageData.height);
        }
        
        // Processar a imagem com ESRGAN e aplicar os efeitos
        processBtn.addEventListener('click', async () => {
            if (!originalImage || !upscaler) {
                alert('Por favor, selecione uma imagem e aguarde o carregamento do modelo.');
                return;
            }
            
            loading.style.display = 'block';
            processBtn.disabled = true;
            
            try {
                // Obter os valores dos controles
                const hdrLevel = document.getElementById('hdrEnhance').value;
                const sharpnessLevel = parseInt(sharpnessSlider.value) / 100;
                const brightnessLevel = parseInt(brightnessSlider.value);
                const contrastLevel = parseInt(contrastSlider.value);
                const saturationLevel = parseInt(saturationSlider.value);
                
                // Primeiro, aplicar o upscale com ESRGAN
                const upscaledImage = await upscaler.upscale(originalImage);
                
                // Criar um canvas para aplicar os efeitos adicionais
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = upscaledImage.width;
                canvas.height = upscaledImage.height;
                
                // Desenhar a imagem upscaled no canvas
                ctx.drawImage(upscaledImage, 0, 0);
                
                // Obter os dados da imagem para processamento
                let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                // Aplicar efeito HDR
                imageData = applyHDREffect(imageData, hdrLevel);
                
                // Aplicar nitidez
                if (sharpnessLevel > 0) {
                    imageData = applySharpness(imageData, sharpnessSlider.value);
                }
                
                // Aplicar ajustes de brilho, contraste e saturação
                imageData = adjustBrightnessContrast(imageData, brightnessLevel, contrastLevel, saturationLevel);
                
                // Colocar a imagem processada de volta no canvas
                ctx.putImageData(imageData, 0, 0);
                
                // Exibir a imagem processada
                processedImageData = canvas.toDataURL('image/png');
                document.getElementById('processedPreview').src = processedImageData;
                document.getElementById('processedInfo').textContent = 
                    `${canvas.width} x ${canvas.height} pixels`;
                
                downloadBtn.style.display = 'inline-block';
            } catch (error) {
                console.error('Erro ao processar a imagem:', error);
                alert('Erro ao processar a imagem. Por favor, tente novamente.');
            } finally {
                loading.style.display = 'none';
                processBtn.disabled = false;
            }
        });
        
        // Baixar a imagem processada
        downloadBtn.addEventListener('click', () => {
            if (!processedImageData) return;
            
            const link = document.createElement('a');
            link.download = 'imagem_ultranitido_4k.png';
            link.href = processedImageData;
            link.click();
        });
    </script>
</body>
</html>
